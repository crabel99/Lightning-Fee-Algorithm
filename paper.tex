\documentclass[review,12pt]{elsarticle}
\usepackage[left=3.2cm, right=3.2cm, top=3.2cm, bottom=3.2cm]{geometry}

\usepackage{lineno, hyperref}
\modulolinenumbers[5]

% \journal{Theoretical Economics}
\usepackage{graphicx}
% \usepackage[abbr]{harvard}
\usepackage{amsmath}
% \usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{braket}
\usepackage{threeparttable}
\usepackage[table]{xcolor}

% Solution to fix compiler warning https://tex.stackexchange.com/a/515199
\usepackage{regexpatch}
\makeatletter
\regexpatchcmd\ps@pprintTitle
  {\cE\}\ \cE\}}{\cE\}\cE\}}
  {}{\FailedToPatch}
\makeatother

% \RequirePackage[colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue,pagebackref]{hyperref}

%%%%%%%%%%%%%%%%%%%%%%%
%% Elsevier bibliography styles
%%%%%%%%%%%%%%%%%%%%%%%
%% To change the style, put a % in front of the second line of the current style and
%% remove the % from the second line of the style you would like to use.
%%%%%%%%%%%%%%%%%%%%%%%

%% Numbered
%\bibliographystyle{model1-num-names}

%% Numbered without titles
%\bibliographystyle{model1a-num-names}

%% Harvard
\bibliographystyle{model2-names.bst}\biboptions{authoryear}

%% Vancouver numbered
%\usepackage{numcompress}\bibliographystyle{model3-num-names}

%% Vancouver name/year
%\usepackage{numcompress}\bibliographystyle{model4-names}\biboptions{authoryear}

%% APA style
%\bibliographystyle{model5-names}\biboptions{authoryear}

%% AMA style
%\usepackage{numcompress}\bibliographystyle{model6-num-names}

%% `Elsevier LaTeX' style
%\bibliographystyle{elsarticle-num}
%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Uncomment next line to change            %%
%% the type of equation numbering           %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\numberwithin{equation}{section}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% For Assumption, Axiom, Claim, Corollary, %%
%% Lemma, Theorem, Proposition, Hypothesis, %%
%% Fact                                     %%
%% use \theoremstyle{plain}                 %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \theoremstyle{plain}
\newtheorem{axiom}{Axiom}
\newtheorem{postulate}{Postulate}
\newtheorem{claim}[axiom]{Claim}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newdefinition{remark}{Remark}
\newdefinition{definition}{Definition}
\newproof{proof}{Proof}
% \newtheorem*{fact}{Fact}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% For Definition, Example, Remark,         %%
%% Notation, Property                       %%
%% use \theoremstyle{remark}                %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \theoremstyle{remark}
% \newtheorem{definition}[theorem]{Definition}
% \newtheorem*{example}{Example}

\newcommand{\proofofref}{}
\newproof{zproofof}{Proof of \proofofref}
\newenvironment{proofof}[1]
 {\renewcommand{\proofofref}{#1}\zproofof}
 {\endzproofof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Local Definitions definitions:           %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator{\Var}{\mathrm{Var}}
\DeclareMathOperator{\Cov}{\mathrm{Cov}}
\DeclareMathOperator{\Tr}{\mathrm{Tr}}
\newcolumntype{L}{>{\centering\arraybackslash}p{0.085\linewidth}}

\begin{document}

\begin{frontmatter}

  \title{Algorithm for Calculating Lightning Node Fees}

  %   %% Group authors per affiliation:
  \author[1]{Cal Abel\texorpdfstring{\footnote{Declarations of interest: none}}}\corref{cor1}
  \address[1]{2600 Century Parkway, Ste. 100, Atlanta, GA, USA}

  %   %% include affiliations in footnotes:
  \author[1]{Skylane Engineering, LLC}
  \ead[url]{https://skylaneengineering.com}

  \cortext[cor1]{Corresponding author}
  \ead{crabel@skylaneengineering.com}

  %   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %   %% Abstract                                 %%
  %   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \begin{abstract}
    This paper outlines a simple strategy to create channels on a Lightning Network routing node that will tend toward a balanced configuration.
    The algorithm is derived from the principles of statistical mechanics and uses the Helmholtz potential to dynamically assess either inbound or outbound fees.
  \end{abstract}

  %   \begin{keyword}

  %   \end{keyword}

\end{frontmatter}

\linenumbers

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Introduction                                                                                %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
The objective of this paper is to lay out the structure of an algorithmic fee structure for routing channel in the Lightning Network.
With current technology, channels are limited in their ability to dynamically assess fees based on channel balance.
What we propose is a method by which a node will use the fee structure to become self balancing, and charging a higher fee for transactions that are routed that take a channel out of balance.

To do this wee need to first formally define a metric for channel balancing.
This is done by treating the sats locked up in a channel as a microcanonical ensemble.
This will provide us with a combinatorial definition of entropy, which when maximized will define a channel being balanced.

The overall approach of this method is to set up a fee structure using the equivalent of the Helmholtz potential.

\section{Defining the Ensemble}
Ensembles are simply collections of a bunch of different things.
They are extremely useful in physics as their application allows the physicist to be able to describe the stochastic behavior of the ensemble's objects under a different set of constraints.
These different constraints create a number of different and corresponding physical potentials.
Three of the more common ensembles are the microcanonical, canonical, and grand canonical.

In the case of the microcanonical ensemble we are seeking to describe a system that is in complete isolation from its surroundings, subject to the constraint of its probabilities summing to unity.
In the canonical distribution, we add the knowledge of the average energy of the system to the constraint of the microcanonical distribution.
This results in the Helmholtz potential, which expresses the amount of energy available to do work.
The grand canonical ensemble adds the constraint of the average occupancy of the energy levels to the canonical ensemble.
This adds the ability for the ensemble to fluctuate in size and energy.
The grand canonical ensemble results in the Gibbs potential which is a measure of doing chemical work.

While we are not considering physics, we are applying the statistical tools to the problem at hand.
As a result, it is important to consider how those tools have been interpreted in another context, to get clues on how to interpret them in the current context.

\subsection{Microcanonical Ensemble}
Let's look at a single sat channel in isolation from its surroundings.
Borrowing from quantum mechanics, we use the Dirac notation to express our vector space.
Because our system is so small we can define an orthonormal basis for our satoshi, with two vectors representing whether the satoshi is in the:
\begin{itemize}
  \item inbound state $\Ket{I}$ or the
  \item outbound state $\Ket{O}$.
\end{itemize}

Because the sat exists classically, a pure state cannot exist as a superposition,
\begin{equation}
  \Ket{\psi} = c_I\Ket{I} + c_O\Ket{O} \; \left\{c_I,c_O\right\} \in \left\{0,1\right\} \textrm{ and } c_I \neq c_O \nonumber
\end{equation}

Now that we have the definition of vector representation of a satoshi, we need to define its potential relative to the direction that it can be "spent".
For the sat in $\Ket{I}$, because it can move to the outbound state, it has a $(+)$ potential and conversely for $\Ket{O}$ a $(-)$ potential.
Because the magnitude of the satoshi's value is symmetric, we can define the the Hamiltonian as,
\begin{equation}
  \hat{H} = \left[ {\begin{array}{cc}
          u_0 & 0    \\
          0   & -u_0 \\
        \end{array} } \right].\nonumber
\end{equation}
Using the properties of the orthonormal basis vectors, we have,
\begin{eqnarray}
  \hat{H}\Ket{I} & = & u_0\Ket{I} \textrm{ and} \nonumber\\
  \hat{H}\Ket{O} & = & -u_0\Ket{O}. \nonumber
\end{eqnarray}
Because the Hamiltonian in this case is only describing potentials, it can have negative eigenvalues.

Since the system is in isolation from its surroundings each of the possible basis vectors is equally probable.
This results in the density matrix,
\begin{equation}
  \hat{\rho} = \left[ {\begin{array}{cc}
          \frac{1}{2} & 0           \\
          0           & \frac{1}{2} \\
        \end{array} } \right].\nonumber
\end{equation}
This is a similar Hamiltonian to a paramagnet.
Unlike a paramagnet the definition of the sign of the potential in a lightning channel is arbitrary, and therefore exhibits a symmetry.

We note that under these conditions the expectation of the Hamiltonian is,
\begin{equation}
  \Braket{\hat{H}} = \Tr \hat{\rho}\hat{H} = 0. \nonumber
\end{equation}

\subsection{Canonical Ensemble}
We define a channel with $M$ total satoshi and describe the occupancy of the inbound state as $m_I$ and the outbound state as $m_O$.
With the larger channel defined, we need to count the number of different ways that it can be configured, its multiplicity,
\begin{equation}
  W = \frac{M!}{m_I!m_O!}. \nonumber
\end{equation}
The multiplicity, $W$, is the number of equally probable configurations for the ensemble.
We define the channel's entropy as,
\begin{equation}
  S \equiv \log W. \nonumber
\end{equation}

For large $M$ we can simplify the entropy by applying the Stirling approximation,
\begin{equation}
  S = \sum_j m_j \log\frac{M}{m_j}.\label{eq:1}
\end{equation}
Equation \ref{eq:1} represents the measure of the channels complexity.
When $S = \max S$, the system is in its most complex configuration.
If we were to convert $S$ to a base-2 logarithm, it would represent the information entropy, or the number of binary questions needed to be asked to determine the location of each satoshi.

Because a channel is fixed in its size, the total number of satoshi are invariant with time.
If we bring the channel onto the network where other channels can access it to route payments, we can consider it as an ensemble of a fixed size brought into contact with a thermal reservoir.
This is the canonical ensemble, whose most probable density matrix is,
\begin{equation}
  \hat{\rho} = \frac{1}{Z}e^{-\beta M \left\lvert \hat{H} \right\rvert}. \nonumber
\end{equation}
Where $Z$ is the normalization constant and is also called the partition function.

\subsection{Perturbations form Equilibrium}
The equilibrium state occurs when the channel is balanced thus the probability of finding a satoshi in either the inbound or outbound channels is $p_I=p_O=1/2$.
If the channel had eigenvalues of the Hamiltonian differing in absolute magnitude, while keeping differing signs, the chanel would have a different equilibrium distribution of occupancy.

Next we consider small perturbations around the equilibrium state.
We recall for the canonical ensemble the Helmholtz potential is,
\begin{equation}
  F \equiv - \frac{1}{\beta}\log Z = \Braket{U} - TS. \nonumber
\end{equation}
Where the temperature is defined as $T \equiv 1/\beta$.

For a small perturbation,
\begin{equation}
  F_{\max S} + \delta F = \Braket{U}_{\max S} + \left\lvert \delta \Braket{U} \right\rvert - T(S_{\max S} + \delta S).\;\footnote{
    We take the absolute value of the perturbation because our definition of the sign of the Hamiltonian eigenvectors was entirely arbitrary.
  } \nonumber
\end{equation}
Which reduces to,
\begin{equation}
  \delta F =  \left\lvert \delta \Braket{U} \right\rvert - T \delta S. \nonumber
\end{equation}

Finally if we take the difference between two perturbations,
\begin{equation}
  \Delta F =  \left\lvert \Delta \Braket{U} \right\rvert - T \Delta S. \label{eq:2}
\end{equation}

We take equation \ref{eq:2} as the difference in the potential between the two near equilibrium channel configurations.
Recalling that the Helmholtz potential represents the amount of available work, we will take this as the available potential for extracting a fee.

The $\left\lvert \Delta \Braket{U} \right\rvert$ represents the traditional channel ppm fee.
However there is an additional fee for moving the channel farther from balance and for bringing it closer to balance, $- T \Delta S$.
It is important to note that the derivation did not include a per transaction fee.

Because equation \ref{eq:2} can be negative, we will exclude the case where the channel operator would pay to balance the channel.
The transaction fee is thus,

\begin{center}
  \boxed{
    \begin{aligned}
       & \textrm{Fee} = \max(0,\left\lvert \Delta \Braket{U} \right\rvert - T \Delta S). \nonumber
    \end{aligned}
  }
\end{center}


\section{Measuring Temperature}
Recall in defining the ensemble that we did not consider the time dependent, kinetic, portion of the Hamiltonian.
It is not something that is clearly defined for sats on a lightning channel.

Instead we need to look at how the channel/node is being used in the entire network.
To do this we need to look at the transaction distribution across the channel/node.
This distribution should follow some form of the gamma distribution.
If this provides a reasonable estimation, the rate factor, $\beta$, is the inverse temperature \cite[p.~76]{Gibbs:1902}.

The node operator would then need to determine what the fractional charge for temperature would satisfactory.
This in effect becomes an average per transaction fee of the change in the entropy.
It's not clear at this time if the measured channel temperature should be used to assess the fee directly, or if it should be multiplied by some constant.

\section{Conclusion}
By adopting a routing fee structure outlined in here, a node signals to the network the state of their channel and how the proposed route impacts the channel to the network through its fee.
By tying the fee to the state of the node and the relation of the transaction to be routed to the fee, we have a clear

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Acknowledgements                                                                            %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section*{Acknowledgements}


\bibliography{paper.bib}

\end{document}
